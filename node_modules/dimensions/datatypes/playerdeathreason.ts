import PacketReader from 'dimensions/packets/packetreader';
import BufferWriter from 'dimensions/packets/bufferwriter';
import BitsByte from './bitsbyte';
import { getPackedStringByteLen } from 'dimensions/utils';

class PlayerDeathReason {
    protected _reasonType: BitsByte | null = null;
    protected _killerPlayerId: number | null = null;
    protected _killingNpcIndex: number | null = null;
    protected _projectileIndex: number | null = null;
    protected _typeOfDeath: BitsByte | null = null;
    protected _projectileType: number | null = null;
    protected _itemType: number | null = null;
    protected _itemPrefix: number | null = null;
    protected _deathReason: string | null = null;

    constructor(reader: PacketReader) {
        this.processDeathReason(reader);
    }

    public get deathReason(): string {
        return this._deathReason || " was killed";
    }

    public get byteLen() {
        let len = 1;
        if (this._killerPlayerId !== null) {
            len += 2;
        }

        if (this._killingNpcIndex !== null) {
            len += 2;
        }

        if (this._projectileIndex !== null) {
            len += 2;
        }

        if (this._reasonType !== null && this._reasonType[3]) {
            len += 1;
        }

        if (this._projectileType !== null) {
            len += 2;
        }

        if (this._itemType !== null) {
            len += 2;
        }

        if (this._itemPrefix !== null) {
            len += 1;
        }

        if (this._deathReason !== null) {
            len += getPackedStringByteLen(this._deathReason);
        }

        return len;
    }

    public getHexData(): Buffer {
        let writer = new BufferWriter(this.byteLen)
        writer.packByte(this._reasonType !== null ? this._reasonType.value : 0)

        if (this._killerPlayerId !== null) {
            writer.packInt16(this._killerPlayerId);
        }

        if (this._killingNpcIndex !== null) {
            writer.packInt16(this._killingNpcIndex);
        }

        if (this._projectileIndex !== null) {
            writer.packInt16(this._projectileIndex);
        }

        if (this._reasonType !== null && this._reasonType[3]) {
            writer.packByte(this._typeOfDeath !== null ? this._typeOfDeath.value : 0);
        }

        if (this._projectileType !== null) {
            writer.packInt16(this._projectileType);
        }

        if (this._itemType !== null) {
            writer.packInt16(this._itemType);
        }

        if (this._itemPrefix !== null) {
            writer.packByte(this._itemPrefix);
        }

        if (this._deathReason !== null) {
            writer.packString(this._deathReason);
        }

        return writer.data;
    }

    protected processDeathReason(reader: PacketReader): void {
        this._reasonType = new BitsByte(reader.readByte());
        if (this._reasonType[0]) {
            this._killerPlayerId = reader.readInt16();
        }

        if (this._reasonType[1]) {
            this._killingNpcIndex = reader.readInt16();
        }

        if (this._reasonType[2]) {
            this._projectileIndex = reader.readInt16();
        }

        if (this._reasonType[3]) {
            this._typeOfDeath = new BitsByte(reader.readByte());
        }

        if (this._reasonType[4]) {
            this._projectileType = reader.readInt16();
        }

        if (this._reasonType[5]) {
            this._itemType = reader.readInt16();
        }

        if (this._reasonType[6]) {
            this._itemPrefix = reader.readByte();
        }

        if (this._reasonType[7]) {
            this._deathReason = reader.readString();
        }
    }
}

export default PlayerDeathReason;
